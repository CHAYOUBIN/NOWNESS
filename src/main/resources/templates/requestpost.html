<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="ko">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/requestpost.css}" rel="stylesheet">
    <title>NOWNESS_detail</title>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var boardId = /*[[${postdetail.id}]]*/;

            // 페이지 로드 시 댓글 가져오기
            getReplyList(boardId);

            // 등록 버튼 클릭 이벤트 처리
            $("#submitbtn").click(function(event) {
                event.preventDefault();
                var replyContents = $("#contents").val();

                // 댓글 등록 AJAX 요청
                $.ajax({
                    url: "/request/writeReply",
                    data: {
                        "userid": /*[[${user.id}]]*/,
                        "contentsid": boardId,
                        "reply": replyContents
                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    type: "post",
                    success: function(result) {
                        if (result === "success") {
                            // 댓글 입력칸 비우기
                            $("#contents").val("");
                            // 새로운 댓글 불러오기
                            getReplyList(boardId);
                        } else {
                            alert("등록 실패");
                        }
                    },
                    error: function() {
                        alert("실패");
                    }
                });
            });

            // 댓글 삭제 버튼 클릭 이벤트 처리
            $(document).on("click", ".deletereplybtn", function(event) {
                event.preventDefault();
                var replyId = $(this).data("replyid");
                // 댓글 삭제 AJAX 요청
                deleteReply(replyId);
            });
        });

        // 댓글 삭제 AJAX 요청
        function deleteReply(replyId) {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                url: "/request/deleteReply",
                data: {
                    "replyId": replyId
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                type: "post",
                success: function(result) {
                    if (result === "success") {
                        var boardId = /*[[${postdetail.id}]]*/;
                        getReplyList(boardId);
                    } else {
                    }
                },
                error: function() {
                }
            });
        }


        // 댓글 리스트 가져오기
        function getReplyList(boardId) {
            $.ajax({
                url: "/request/getComments",
                data: {
                    "contentsid": boardId
                },
                type: "get",
                success: function(result) {
                    // 댓글 보여주기
                    drawReply(result);
                },
                error: function() {
                }
            });
        }


        // 댓글 보여주는 기능
        function drawReply(replys) {
            var html = '';

            replys.forEach(function(reply) {
                if (reply.parentid == 0) {
                    html += '<div class="row"><div class="col-sm-12">';
                    html += '<form class="form-inline" action="/writeReply" method="post">';
                    html += '<label for="pwd" class="mr-sm-2">' + "[작성자 : " + reply.id + " ] " +'</label>';
                    html += '<label for="pwd" class="mr-sm-2">'  +  reply.reply + '</label>';
                    html += '<label for="pwd" class="mr-sm-2">' + "( " + reply.createddatetime + ")"+ '</label>';
                    html += '<button type="button" class="btn btn-primary mb-2 deletereplybtn" data-replyid="' + reply.id + '">❌</button>';
                    html += '<input type="hidden" name="id" th:value="${postdetail.id}">';
                    html += '<input type="hidden" name="parentid" th:value="' + reply.id + '">';
                    html += '</form>';
                    html += '<hr>';
                    html += '<div class="row"><div class="col-sm-12 sub' + reply.id + '"></div></div></div></div>';
                }
            });

            $("#replyArea").html(html);

            replys.forEach(function(reply) {
                if (reply.parentid != 0) {
                    var subHtml = '';
                    subHtml = '<div class="row"><div class="col-sm-12 subReply">';
                    subHtml += 'ㄴ <label for="pwd" class="col-sm-12 sub">'+ "[작성자 : " + reply.id + " ] "  + reply.reply + "( " + reply.createddatetime + ")"+  '</label>';
                    subHtml += '<button type="button" class="col-sm-12 sub deletereplybtn" data-replyid="' + reply.id + '">❌</button>';
                    subHtml += '<hr>';
                    subHtml += '<div class="row"><div class="col-sm-12 sub' + reply.id + '"></div></div></div></div>';
                    $(".sub" + reply.parentid).append(subHtml);
                }
            });
        }
    </script>

</head>




<body>
<!--헤더-->
<div th:insert="~{header :: header}"></div>

<!--바디-본문-->

<!--게시글 세부내용 본문-->
<div class="container">

    <!--게시글 상세내용-->
    <div id="main">
        <article class="post">
            <!-- 게시글 내부 header : 진짜 헤더랑 겹칠거같음..??-->
            <header>
                <div class="title">
                    <h2 th:text="${postdetail.title}"></h2>
                </div>

                <!--오른쪽부분 날짜와 닉네임-->
                <div class="meta">
                    <time class="published" datetime="2015-11-01" th:text="${postdetail.createdDatetime}"></time>
                    <a href="#" class="author"><span class="name" th:text="${nickname}"></span><img src="images/avatar.jpg" alt="" /></a>
                </div>
            </header>

            <!-- 글 본문 자리-->
            <p th:utext="${postdetail.contents}"></p>


            <!--게시글 내부 footer : 나중에 겹치는지?? 바꿔야야할듯..-->
            <footer>
                <ul class="stats">
                    <li><a href="#" class="icon solid fa-viewt">view <span th:text="${postdetail.views}"></span></a></li>
                    <li><a href="#" class="icon solid fa-heart"><span th:text="${likes}"></span></a></li>
                    <li><a href="#" class="icon solid fa-comment">comment <span th:text="${comments.size()}"></span></a></li>
                    <li><a href="#" class="icon solid fa-modify">modify</a></li>
                    <li><a th:href="@{'/request/post/' + ${id} + '/delete'}" class="icon solid fa-delete">delete</a></li>
                    <li><a href="#" class="icon solid fa-report">report</a></li>
                </ul>
                <ul class="hash">
                    <li></li>
                </ul>

            </footer>
        </article>
    </div> <!--게시글내용 div end-->


    <!--댓글등록-->
    <form id="commentForm" class="form-inline" th:action="@{/request/writeReply}" method="post">
        <input type="hidden" name="userid"  th:value="${user.id}">
        <input type="hidden" name="contentsid" th:value="${postdetail.id}">
        <input type="text" class="form-control mb-2 mr-sm-2" id="contents" placeholder="댓글을 입력하세요" name="reply" required>
        <button type="button" class="btn btn-primary mb-2" id="submitbtn">등록</button>
    </form>


    <!--댓글 보여주는 곳 -->
    <div class="comments">
        <h2 id="cnt"></h2>
        <div id="replyArea"></div>
    </div>


    <!--    <span th:text="${user}"></span>-->
    <!--    <br>-->
    <!--    <span th:text="${user.id}"></span>-->



    <div th:insert="~{footer :: footer}"></div>
    <script th:src="@{/static/js/bootstrap.min.js}"></script>
</div>
</body>
</html>


